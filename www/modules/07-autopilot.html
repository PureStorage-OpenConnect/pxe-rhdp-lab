<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 07 - PVC Auto Resize using AutoPilot :: Showroom Template Demo</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/modules/07-autopilot.html">
    <link rel="prev" href="06-snapshot-schedules.html">
    <link rel="next" href="module-01.html">
    <meta name="generator" content="Antora 3.1.9">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://demo.redhat.com" target="_blank" style="margin-left: 5%;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1508.5 178.739" style="width: 278px;"><g fill="#fff"><path d="M316.6 63.2v-56H342a21.279 21.279 0 0 1 7.8 1.3 18.111 18.111 0 0 1 5.9 3.5 15.577 15.577 0 0 1 5 11.8 15.051 15.051 0 0 1-3.1 9.5 16.836 16.836 0 0 1-8.4 5.8l12.5 24.1h-9.3l-11.6-23H325v23Zm24.7-48.6H325v18.7h16.3q5.25 0 8.1-2.7a8.7 8.7 0 0 0 2.8-6.6 8.7 8.7 0 0 0-2.8-6.6c-1.8-1.9-4.5-2.8-8.1-2.8ZM364.1 42.8a20.674 20.674 0 0 1 1.6-8.2 20.288 20.288 0 0 1 4.3-6.7 19.92 19.92 0 0 1 6.5-4.5 19.718 19.718 0 0 1 8-1.6 18.463 18.463 0 0 1 7.8 1.6 18.677 18.677 0 0 1 6.2 4.5 20.927 20.927 0 0 1 4.1 6.8 23.2 23.2 0 0 1 1.5 8.4v2.3H372a13.822 13.822 0 0 0 4.6 8.4 13.6 13.6 0 0 0 9.1 3.3 15.553 15.553 0 0 0 5.7-1 12.858 12.858 0 0 0 4.6-2.6l5.1 5a25.983 25.983 0 0 1-7.4 4.1 24.69 24.69 0 0 1-8.4 1.3 21.306 21.306 0 0 1-8.4-1.6 22.763 22.763 0 0 1-6.8-4.4 20.788 20.788 0 0 1-4.5-6.7 23.2 23.2 0 0 1-1.5-8.4Zm20.2-14.2a11.527 11.527 0 0 0-8 3 13.046 13.046 0 0 0-4.2 7.8h24.2a13.091 13.091 0 0 0-4.2-7.8 11.106 11.106 0 0 0-7.8-3ZM443.1 63.2v-3.8a19.448 19.448 0 0 1-5.8 3.3 18.924 18.924 0 0 1-6.7 1.2 19.824 19.824 0 0 1-14.6-6.1 22.268 22.268 0 0 1-4.4-6.7 21.812 21.812 0 0 1 0-16.4A20.534 20.534 0 0 1 416 28a19.335 19.335 0 0 1 6.6-4.5 20.334 20.334 0 0 1 8.2-1.6 20.7 20.7 0 0 1 6.6 1 19.415 19.415 0 0 1 5.7 3V7.2l8-1.8v57.8Zm-25.2-20.4a13.718 13.718 0 0 0 4 10.1 13.45 13.45 0 0 0 9.8 4.1 14.956 14.956 0 0 0 6.4-1.3 15.954 15.954 0 0 0 4.9-3.6V33.6a14.988 14.988 0 0 0-4.9-3.5 15.271 15.271 0 0 0-6.4-1.3 13.423 13.423 0 0 0-9.9 4 13.806 13.806 0 0 0-3.9 10ZM478.1 63.2v-56h8.4v24h29.8v-24h8.4v56h-8.4V38.8h-29.8v24.4ZM547.2 64a16.483 16.483 0 0 1-10.8-3.5 11.037 11.037 0 0 1-4.2-8.9 10.375 10.375 0 0 1 4.7-9.2 20.76 20.76 0 0 1 11.8-3.2 27.841 27.841 0 0 1 5.8.6 27.374 27.374 0 0 1 5.3 1.6v-4.3a8.143 8.143 0 0 0-2.6-6.5 11.452 11.452 0 0 0-7.4-2.2 20.788 20.788 0 0 0-6 .9 34.616 34.616 0 0 0-6.6 2.6l-3-6a54.169 54.169 0 0 1 8.4-3.1 33.18 33.18 0 0 1 8.3-1.1c5.2 0 9.3 1.3 12.2 3.8s4.4 6.1 4.4 10.8v27h-7.8v-3.5a19.441 19.441 0 0 1-5.8 3.2 23.54 23.54 0 0 1-6.7 1Zm-7.3-12.6a5.646 5.646 0 0 0 2.6 4.8 11.193 11.193 0 0 0 6.6 1.8 16.256 16.256 0 0 0 5.9-1 14.449 14.449 0 0 0 4.9-2.9V47a19.778 19.778 0 0 0-4.8-1.8 24.933 24.933 0 0 0-5.7-.6 11.859 11.859 0 0 0-6.8 1.8 5.728 5.728 0 0 0-2.7 5ZM580.6 53.2v-24H572v-6.7h8.6V12.1l7.9-1.9v12.3h12v6.7h-12v22.1a5.94 5.94 0 0 0 1.4 4.4c.9.9 2.5 1.3 4.6 1.3a23.637 23.637 0 0 0 3-.2 10.857 10.857 0 0 0 2.8-.8v6.7a19.28 19.28 0 0 1-3.8.9 27.484 27.484 0 0 1-3.8.3c-3.9 0-7-.9-9-2.8-2-1.7-3.1-4.4-3.1-7.9Z"></path></g><path d="M127 90.2c12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4L149.8 37c-1.7-7.1-3.2-10.3-15.7-16.6-9.7-5-30.8-13.1-37.1-13.1-5.8 0-7.5 7.5-14.4 7.5-6.7 0-11.6-5.6-17.9-5.6-6 0-9.9 4.1-12.9 12.5 0 0-8.4 23.7-9.5 27.2a4.216 4.216 0 0 0-.3 1.9c0 9.2 36.3 39.4 85 39.4Zm32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3C21.8 58.8 0 61.8 0 81c0 31.5 74.6 70.3 133.7 70.3 45.3 0 56.7-20.5 56.7-36.6-.1-12.8-11-27.3-30.9-35.9Z" fill="#e00"></path><path d="M159.5 78.8c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3l3.7-9.1a4.877 4.877 0 0 0-.3 2c0 9.2 36.3 39.4 85 39.4 12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4Z"></path><path d="M253.5 158.7a2.22 2.22 0 0 1-2.2-2.2V2.2a2.2 2.2 0 0 1 4.4 0v154.2a2.242 2.242 0 0 1-2.2 2.3Z" fill="#fff"></path><text data-name="Demo Platform" transform="translate(1186 149)" fill="#fff" font-size="82" font-family="'RedHatDisplay', 'Overpass', overpass, helvetica, arial, sans-serif" font-weight="700"><tspan x="-877.892" y="0">Demo Platform</tspan></text></svg>
      </a>
      <a class="navbar-item site-title" target="__blank" style="color: #fff !important;" href="https://redhat-scholars.github.io/course-template">Showroom Template Demo</a>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item navbar-item-right-dropdown has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Links</a>
          <div class="navbar-dropdown navbar-dropdown-right">
            <a class="navbar-item navbar-item-right-content" href="https://redhat.com" target="_blank">Red Hat</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="modules" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Default Title</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01-explore-rhpds.html">1. Explore Redhat Openshift and Portworx</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-review-ocp-storage.html">2. Review OCP Storage</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-apache-cassandra.html">3. Snapshots with Cassandra</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-shared-volumes.html">4. Working with shared volumes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-cloud-snapshots.html">5. Cloud Snapshots</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-snapshot-schedules.html">6. Creating Snapshot Schedules</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="07-autopilot.html">7. Automated capacity management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Dev Mode</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="module-01.html">Building an Application with rpms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="module-02.html">Managing an Application from GitHub</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="attrs-page.html">Attributes Page</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Default Title</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Default Title</a></li>
    <li><a href="07-autopilot.html">7. Automated capacity management</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab 07 - PVC Auto Resize using AutoPilot</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this step, we will create a Portworx volume (PVC) for postgres.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_storageclass_and_persistentvolumeclaim"><a class="anchor" href="#_create_storageclass_and_persistentvolumeclaim"></a>Create StorageClass and PersistentVolumeClaim</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Take a look at the StorageClass definition for Portworx</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc delete sc px-repl3-sc
cat &lt;&lt;EOF | oc apply -f -
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: px-repl3-sc
provisioner: pxd.portworx.com
parameters:
  repl: "3"
  io_profile: "db"
  priority_io: "high"
allowVolumeExpansion: true
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>The parameters are declarative policies for your storage volume. Notice
the “allowVolumeExpansion: true” this needs to be added for kubernetes
volume expansion. See
<a href="https://docs.portworx.com/portworx-install-with-kubernetes/storage-operations/create-pvcs/dynamic-provisioning/">here</a>
for a full list of supported parameters.</p>
</div>
<div class="paragraph">
<p>We will also need to apply a configmap to allow Openshift&#8217;s prometheus
instance to monitor Portworx events.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
during the next test phase omit this config map and wait 15
minutes after the pg bench command to ensure it is needed.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-monitoring-config
  namespace: openshift-monitoring
data:
  config.yaml: |
    enableUserWorkload: true
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new Persistent Volume Claim</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc apply -f -
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: px-postgres-pvc
  labels:
    app: postgres
spec:
  storageClassName: px-repl3-sc
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines the maximum volume size. Portworx will thin provision the
volume.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_secret_for_postgres"><a class="anchor" href="#_create_secret_for_postgres"></a>Create secret for postgres</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below we are creating a Secret to store the postgres password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">echo -n mysql123 &gt; /tmp/password.txt
oc create secret generic postgres-pass --from-file=/tmp/password.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below we will create a Postgres
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a>
that uses a Portworx PVC.</p>
</div>
<div class="sect2">
<h3 id="_deploy_postgres"><a class="anchor" href="#_deploy_postgres"></a>Deploy Postgres</h3>
<div class="paragraph">
<p>Now that we have the volumes created, let’s deploy Postgres !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc create -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  replicas: 1
  template:
    metadata:
      labels:
        app: postgres
    spec:
      schedulerName: stork
      containers:
      - name: postgres
        image: postgres:9.5
        imagePullPolicy: "IfNotPresent"
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_USER
          value: pgbench
        - name: PGUSER
          value: pgbench
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-pass
              key: password.txt
        - name: PGBENCH_PASSWORD
          value: superpostgres
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        volumeMounts:
        - mountPath: /var/lib/postgresql/data
          name: postgredb
      volumes:
      - name: postgredb
        persistentVolumeClaim:
          claimName: px-postgres-pvc
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Observe the <code>volumeMounts</code> and <code>volumes</code> sections where we mount the
PVC.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verify_postgres_pod_is_ready"><a class="anchor" href="#_verify_postgres_pod_is_ready"></a>Verify postgres pod is ready</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below commands wait till the postgres pods are in ready state.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get pods -l app=postgres -o wide</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the pod is in Running state then then hit <code>ctrl-c</code> to exit.</p>
</div>
<div class="paragraph">
<p>In this step, we will use pxctl to inspect the volume</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inspect_the_portworx_volume"><a class="anchor" href="#_inspect_the_portworx_volume"></a>Inspect the Portworx volume</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Portworx ships with a
<a href="https://docs.portworx.com/reference/cli/basics/">pxctl</a> command line that
can be used to manage Portworx.</p>
</div>
<div class="paragraph">
<p>Below we will use pxctl to inspect the underlying volume for our PVC.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">VOL=$(oc get pvc | grep px-postgres-pvc | awk '{print $3}')
pxctl volume inspect ${VOL}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make the following observations in the inspect output * <code>State</code>
indicates the volume is attached and shows the node on which it is
attached. This is the node where the Kubernetes pod is running. * <code>HA</code>
shows the number of configured replicas for this volume * <code>Labels</code> show
the name of the PVC for this volume * <code>Replica sets on nodes</code> shows the
px nodes on which volume is replicated * <code>Size</code> of the volume is 1GB.
We&#8217;ll check this later to see our volume property expanded.</p>
</div>
<div class="paragraph">
<p>Now that we have PostgreSQL up, let&#8217;s proceed to setting up our
AutoPilot rule!</p>
</div>
<div class="paragraph">
<p>In this step, we will configure the AutoPilot rule for Postgres</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_autopilot_rule"><a class="anchor" href="#_configure_autopilot_rule"></a>Configure Autopilot Rule</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learn more about
<a href="https://2.11.docs.portworx.com/portworx-install-with-kubernetes/autopilot/how-to-use/working-with-rules/#understanding-an-autopilotrule">working
with AutoPilot Rules</a> in the Portworx documentation.</p>
</div>
<div class="paragraph">
<p>Keep in mind, an AutoPilot Rule has 4 main parts.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Selector</code> Matches labels on the objects that the rule should monitor.</p>
</li>
<li>
<p><code>Namespace Selector</code> Matches labels on the Kubernetes namespaces the
rule should monitor. This is optional, and the default is all
namespaces.</p>
</li>
<li>
<p><code>Conditions</code> The metrics for the objects to monitor.</p>
</li>
<li>
<p><code>Actions</code> to perform once the metric conditions are met.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below we target the Postgres PVC using an AutPilot Rule.</p>
</div>
<div class="paragraph">
<p>Create the AutoPilot Rule -----------------------</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc apply -f -
apiVersion: autopilot.libopenstorage.org/v1alpha1
kind: AutopilotRule
metadata:
  name: auto-volume-resize
spec:
  selector:
    matchLabels:
      app: postgres
  conditions:
    # volume usage should be less than 20%
    expressions:
    - key: "100 * (px_volume_usage_bytes / px_volume_capacity_bytes)"
      operator: Gt
      values:
        - "20"
    # volume capacity should not exceed 400GiB
    - key: "px_volume_capacity_bytes / 1000000000"
      operator: Lt
      values:
       - "20"
  actions:
  - name: openstorage.io.action.volume/resize
    params:
      # resize volume by scalepercentage of current size
      scalepercentage: "200"
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we are defining the <code>condition</code> and the <code>action</code> in which our
Rule is activated. In our Rule we are defining when our volume is using
<code>20%</code> of its total available capacity, then we grow the volume using the
<code>openstorage.io.action.volume/resize</code> action by 200 percent. Normally,
you would likely use a larger threshold for volume usage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verify_that_autopilot_initialized_the_postgres_pvc"><a class="anchor" href="#_verify_that_autopilot_initialized_the_postgres_pvc"></a>Verify that AutoPilot initialized the Postgres PVC</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get events --field-selector involvedObject.kind=AutopilotRule,involvedObject.name=auto-volume-resize --all-namespaces</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check to see that AutoPilot has recognized the PVC and initialized it.
When the events show <code>transition from Initializing &#8658; Normal</code> for the
Postgres PVC, AutoPilot is ready. Hit <code>ctrl-c</code> to exit.</p>
</div>
<div class="paragraph">
<p>In this step, we will run a benchmark that uses more than 20% of our
volume and show how AutoPilot dynamically increases the volume size
without downtime or user intervention.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_open_a_shell_inside_the_postgres_container"><a class="anchor" href="#_open_a_shell_inside_the_postgres_container"></a>Open a shell inside the postgres container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below commands exec into the postgres pod:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">POD=`oc get pods -l app=postgres | grep Running | grep 1/1 | awk '{print $1}'`
oc exec -it $POD -- bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we can launch the psql utility and create a database</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">psql
create database pxdemo;
\l
\q</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use pgbench to run a baseline transaction benchmark which will try to
grow the volume to a size that is greater than the 20% that we defined
in our AutoPilot Rule. This should trigger AutoPilot to resize the
volume.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">pgbench -i -s 50 pxdemo</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Note</div>
<div class="paragraph">
<p>Note that once the test completes, <strong>AutoPilot will make sure the usage
remains above 20% for about 30 seconds before triggering the rule.</strong> Type
<code>exit</code> to exit from the pod shell before proceeding.
====[source,shell]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>exit</pre>
</div>
</div>
<div class="paragraph">
<p>== Check to see if the rule was triggered</p>
</div>
<div class="paragraph">
<p>We can retrieve events by using the <code>oc get events</code> and filtering for
<code>AutoPilotRule</code> events that match our use case. Note, that AutoPilot
delays the rule from being triggered immediately to ensure that the
conditions stablize, so make sure to <strong>hang tight and see the rule get
triggered if you dont see it right away, it may take a minute or two</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get events --field-selector involvedObject.kind=AutopilotRule,involvedObject.name=auto-volume-resize --all-namespaces</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you see <code>Triggered &#8658; ActiveActionsPending</code> the action has been
activated. When you see <code>ActiveActionsInProgress &#8658; ActiveActionsTake</code>
this means the resize has taken place and your volume should be resized
by <strong>200%</strong>. Hit <code>ctrl-c</code> to clear the screen.</p>
</div>
<div class="paragraph">
<p>Inspect the volume and verify that it now has grown by 200% capacity
(3GB).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pvc px-postgres-pvc</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the volume is now expanded and our PostgresDB database
didn&#8217;t require restarting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>== Manual resize of PVC</p>
</div>
<div class="paragraph">
<p>It is also possible to manually resize a PVC. Below we will resize the
volume to 4GiB.</p>
</div>
<div class="paragraph">
<p>Edit the existing PVC and change the size to 4GiB.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc edit pvc px-postgres-pvc</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Check out the utilization of the volume after the resize.</p>
</div>
<div class="paragraph">
<p>It takes approximately 30s to complete resizing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc describe pvc px-postgres-pvc</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see events that the PVC was successfully resized and that the
volume is now 4GiB.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="06-snapshot-schedules.html" class="query-params-link">6. Creating Snapshot Schedules</a></span>
  <span class="next"><a href="module-01.html" class="query-params-link">Building an Application with rpms</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>  </div>
</main>
</div>
<footer class="footer">
  <a href="https://demo.redhat.com" target="_blank" class="poweredBy"><p>Powered by</p><div class="labInfo_poweredBy" style="display: block; width: 260px;"><svg class="labInfo_poweredByLogo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1508.5 178.739"><g fill="#111"><path d="M316.6 63.2v-56H342a21.279 21.279 0 0 1 7.8 1.3 18.111 18.111 0 0 1 5.9 3.5 15.577 15.577 0 0 1 5 11.8 15.051 15.051 0 0 1-3.1 9.5 16.836 16.836 0 0 1-8.4 5.8l12.5 24.1h-9.3l-11.6-23H325v23Zm24.7-48.6H325v18.7h16.3q5.25 0 8.1-2.7a8.7 8.7 0 0 0 2.8-6.6 8.7 8.7 0 0 0-2.8-6.6c-1.8-1.9-4.5-2.8-8.1-2.8ZM364.1 42.8a20.674 20.674 0 0 1 1.6-8.2 20.288 20.288 0 0 1 4.3-6.7 19.92 19.92 0 0 1 6.5-4.5 19.718 19.718 0 0 1 8-1.6 18.463 18.463 0 0 1 7.8 1.6 18.677 18.677 0 0 1 6.2 4.5 20.927 20.927 0 0 1 4.1 6.8 23.2 23.2 0 0 1 1.5 8.4v2.3H372a13.822 13.822 0 0 0 4.6 8.4 13.6 13.6 0 0 0 9.1 3.3 15.553 15.553 0 0 0 5.7-1 12.858 12.858 0 0 0 4.6-2.6l5.1 5a25.983 25.983 0 0 1-7.4 4.1 24.69 24.69 0 0 1-8.4 1.3 21.306 21.306 0 0 1-8.4-1.6 22.763 22.763 0 0 1-6.8-4.4 20.788 20.788 0 0 1-4.5-6.7 23.2 23.2 0 0 1-1.5-8.4Zm20.2-14.2a11.527 11.527 0 0 0-8 3 13.046 13.046 0 0 0-4.2 7.8h24.2a13.091 13.091 0 0 0-4.2-7.8 11.106 11.106 0 0 0-7.8-3ZM443.1 63.2v-3.8a19.448 19.448 0 0 1-5.8 3.3 18.924 18.924 0 0 1-6.7 1.2 19.824 19.824 0 0 1-14.6-6.1 22.268 22.268 0 0 1-4.4-6.7 21.812 21.812 0 0 1 0-16.4A20.534 20.534 0 0 1 416 28a19.335 19.335 0 0 1 6.6-4.5 20.334 20.334 0 0 1 8.2-1.6 20.7 20.7 0 0 1 6.6 1 19.415 19.415 0 0 1 5.7 3V7.2l8-1.8v57.8Zm-25.2-20.4a13.718 13.718 0 0 0 4 10.1 13.45 13.45 0 0 0 9.8 4.1 14.956 14.956 0 0 0 6.4-1.3 15.954 15.954 0 0 0 4.9-3.6V33.6a14.988 14.988 0 0 0-4.9-3.5 15.271 15.271 0 0 0-6.4-1.3 13.423 13.423 0 0 0-9.9 4 13.806 13.806 0 0 0-3.9 10ZM478.1 63.2v-56h8.4v24h29.8v-24h8.4v56h-8.4V38.8h-29.8v24.4ZM547.2 64a16.483 16.483 0 0 1-10.8-3.5 11.037 11.037 0 0 1-4.2-8.9 10.375 10.375 0 0 1 4.7-9.2 20.76 20.76 0 0 1 11.8-3.2 27.841 27.841 0 0 1 5.8.6 27.374 27.374 0 0 1 5.3 1.6v-4.3a8.143 8.143 0 0 0-2.6-6.5 11.452 11.452 0 0 0-7.4-2.2 20.788 20.788 0 0 0-6 .9 34.616 34.616 0 0 0-6.6 2.6l-3-6a54.169 54.169 0 0 1 8.4-3.1 33.18 33.18 0 0 1 8.3-1.1c5.2 0 9.3 1.3 12.2 3.8s4.4 6.1 4.4 10.8v27h-7.8v-3.5a19.441 19.441 0 0 1-5.8 3.2 23.54 23.54 0 0 1-6.7 1Zm-7.3-12.6a5.646 5.646 0 0 0 2.6 4.8 11.193 11.193 0 0 0 6.6 1.8 16.256 16.256 0 0 0 5.9-1 14.449 14.449 0 0 0 4.9-2.9V47a19.778 19.778 0 0 0-4.8-1.8 24.933 24.933 0 0 0-5.7-.6 11.859 11.859 0 0 0-6.8 1.8 5.728 5.728 0 0 0-2.7 5ZM580.6 53.2v-24H572v-6.7h8.6V12.1l7.9-1.9v12.3h12v6.7h-12v22.1a5.94 5.94 0 0 0 1.4 4.4c.9.9 2.5 1.3 4.6 1.3a23.637 23.637 0 0 0 3-.2 10.857 10.857 0 0 0 2.8-.8v6.7a19.28 19.28 0 0 1-3.8.9 27.484 27.484 0 0 1-3.8.3c-3.9 0-7-.9-9-2.8-2-1.7-3.1-4.4-3.1-7.9Z"></path></g><path d="M127 90.2c12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4L149.8 37c-1.7-7.1-3.2-10.3-15.7-16.6-9.7-5-30.8-13.1-37.1-13.1-5.8 0-7.5 7.5-14.4 7.5-6.7 0-11.6-5.6-17.9-5.6-6 0-9.9 4.1-12.9 12.5 0 0-8.4 23.7-9.5 27.2a4.216 4.216 0 0 0-.3 1.9c0 9.2 36.3 39.4 85 39.4Zm32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3C21.8 58.8 0 61.8 0 81c0 31.5 74.6 70.3 133.7 70.3 45.3 0 56.7-20.5 56.7-36.6-.1-12.8-11-27.3-30.9-35.9Z" fill="#e00"></path><path d="M159.5 78.8c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3l3.7-9.1a4.877 4.877 0 0 0-.3 2c0 9.2 36.3 39.4 85 39.4 12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4Z"></path><path d="M253.5 158.7a2.22 2.22 0 0 1-2.2-2.2V2.2a2.2 2.2 0 0 1 4.4 0v154.2a2.242 2.242 0 0 1-2.2 2.3Z" fill="#111"></path><text data-name="Demo Platform" transform="translate(1186 149)" fill="#111" font-size="82" font-family="'RedHatDisplay', 'Overpass', overpass, helvetica, arial, sans-serif" font-weight="700"><tspan x="-877.892" y="0">Demo Platform</tspan></text></svg></div></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
