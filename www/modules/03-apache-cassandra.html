<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 03 - Apache Cassandra :: Showroom Template Demo</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/modules/03-apache-cassandra.html">
    <link rel="prev" href="02-review-ocp-storage.html">
    <link rel="next" href="04-shared-volumes.html">
    <meta name="generator" content="Antora 3.1.9">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://demo.redhat.com" target="_blank" style="margin-left: 5%;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1508.5 178.739" style="width: 278px;"><g fill="#fff"><path d="M316.6 63.2v-56H342a21.279 21.279 0 0 1 7.8 1.3 18.111 18.111 0 0 1 5.9 3.5 15.577 15.577 0 0 1 5 11.8 15.051 15.051 0 0 1-3.1 9.5 16.836 16.836 0 0 1-8.4 5.8l12.5 24.1h-9.3l-11.6-23H325v23Zm24.7-48.6H325v18.7h16.3q5.25 0 8.1-2.7a8.7 8.7 0 0 0 2.8-6.6 8.7 8.7 0 0 0-2.8-6.6c-1.8-1.9-4.5-2.8-8.1-2.8ZM364.1 42.8a20.674 20.674 0 0 1 1.6-8.2 20.288 20.288 0 0 1 4.3-6.7 19.92 19.92 0 0 1 6.5-4.5 19.718 19.718 0 0 1 8-1.6 18.463 18.463 0 0 1 7.8 1.6 18.677 18.677 0 0 1 6.2 4.5 20.927 20.927 0 0 1 4.1 6.8 23.2 23.2 0 0 1 1.5 8.4v2.3H372a13.822 13.822 0 0 0 4.6 8.4 13.6 13.6 0 0 0 9.1 3.3 15.553 15.553 0 0 0 5.7-1 12.858 12.858 0 0 0 4.6-2.6l5.1 5a25.983 25.983 0 0 1-7.4 4.1 24.69 24.69 0 0 1-8.4 1.3 21.306 21.306 0 0 1-8.4-1.6 22.763 22.763 0 0 1-6.8-4.4 20.788 20.788 0 0 1-4.5-6.7 23.2 23.2 0 0 1-1.5-8.4Zm20.2-14.2a11.527 11.527 0 0 0-8 3 13.046 13.046 0 0 0-4.2 7.8h24.2a13.091 13.091 0 0 0-4.2-7.8 11.106 11.106 0 0 0-7.8-3ZM443.1 63.2v-3.8a19.448 19.448 0 0 1-5.8 3.3 18.924 18.924 0 0 1-6.7 1.2 19.824 19.824 0 0 1-14.6-6.1 22.268 22.268 0 0 1-4.4-6.7 21.812 21.812 0 0 1 0-16.4A20.534 20.534 0 0 1 416 28a19.335 19.335 0 0 1 6.6-4.5 20.334 20.334 0 0 1 8.2-1.6 20.7 20.7 0 0 1 6.6 1 19.415 19.415 0 0 1 5.7 3V7.2l8-1.8v57.8Zm-25.2-20.4a13.718 13.718 0 0 0 4 10.1 13.45 13.45 0 0 0 9.8 4.1 14.956 14.956 0 0 0 6.4-1.3 15.954 15.954 0 0 0 4.9-3.6V33.6a14.988 14.988 0 0 0-4.9-3.5 15.271 15.271 0 0 0-6.4-1.3 13.423 13.423 0 0 0-9.9 4 13.806 13.806 0 0 0-3.9 10ZM478.1 63.2v-56h8.4v24h29.8v-24h8.4v56h-8.4V38.8h-29.8v24.4ZM547.2 64a16.483 16.483 0 0 1-10.8-3.5 11.037 11.037 0 0 1-4.2-8.9 10.375 10.375 0 0 1 4.7-9.2 20.76 20.76 0 0 1 11.8-3.2 27.841 27.841 0 0 1 5.8.6 27.374 27.374 0 0 1 5.3 1.6v-4.3a8.143 8.143 0 0 0-2.6-6.5 11.452 11.452 0 0 0-7.4-2.2 20.788 20.788 0 0 0-6 .9 34.616 34.616 0 0 0-6.6 2.6l-3-6a54.169 54.169 0 0 1 8.4-3.1 33.18 33.18 0 0 1 8.3-1.1c5.2 0 9.3 1.3 12.2 3.8s4.4 6.1 4.4 10.8v27h-7.8v-3.5a19.441 19.441 0 0 1-5.8 3.2 23.54 23.54 0 0 1-6.7 1Zm-7.3-12.6a5.646 5.646 0 0 0 2.6 4.8 11.193 11.193 0 0 0 6.6 1.8 16.256 16.256 0 0 0 5.9-1 14.449 14.449 0 0 0 4.9-2.9V47a19.778 19.778 0 0 0-4.8-1.8 24.933 24.933 0 0 0-5.7-.6 11.859 11.859 0 0 0-6.8 1.8 5.728 5.728 0 0 0-2.7 5ZM580.6 53.2v-24H572v-6.7h8.6V12.1l7.9-1.9v12.3h12v6.7h-12v22.1a5.94 5.94 0 0 0 1.4 4.4c.9.9 2.5 1.3 4.6 1.3a23.637 23.637 0 0 0 3-.2 10.857 10.857 0 0 0 2.8-.8v6.7a19.28 19.28 0 0 1-3.8.9 27.484 27.484 0 0 1-3.8.3c-3.9 0-7-.9-9-2.8-2-1.7-3.1-4.4-3.1-7.9Z"></path></g><path d="M127 90.2c12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4L149.8 37c-1.7-7.1-3.2-10.3-15.7-16.6-9.7-5-30.8-13.1-37.1-13.1-5.8 0-7.5 7.5-14.4 7.5-6.7 0-11.6-5.6-17.9-5.6-6 0-9.9 4.1-12.9 12.5 0 0-8.4 23.7-9.5 27.2a4.216 4.216 0 0 0-.3 1.9c0 9.2 36.3 39.4 85 39.4Zm32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3C21.8 58.8 0 61.8 0 81c0 31.5 74.6 70.3 133.7 70.3 45.3 0 56.7-20.5 56.7-36.6-.1-12.8-11-27.3-30.9-35.9Z" fill="#e00"></path><path d="M159.5 78.8c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3l3.7-9.1a4.877 4.877 0 0 0-.3 2c0 9.2 36.3 39.4 85 39.4 12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4Z"></path><path d="M253.5 158.7a2.22 2.22 0 0 1-2.2-2.2V2.2a2.2 2.2 0 0 1 4.4 0v154.2a2.242 2.242 0 0 1-2.2 2.3Z" fill="#fff"></path><text data-name="Demo Platform" transform="translate(1186 149)" fill="#fff" font-size="82" font-family="'RedHatDisplay', 'Overpass', overpass, helvetica, arial, sans-serif" font-weight="700"><tspan x="-877.892" y="0">Demo Platform</tspan></text></svg>
      </a>
      <a class="navbar-item site-title" target="__blank" style="color: #fff !important;" href="https://redhat-scholars.github.io/course-template">Showroom Template Demo</a>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item navbar-item-right-dropdown has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Links</a>
          <div class="navbar-dropdown navbar-dropdown-right">
            <a class="navbar-item navbar-item-right-content" href="https://redhat.com" target="_blank">Red Hat</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="modules" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Default Title</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01-explore-rhpds.html">1. Explore Redhat Openshift and Portworx</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-review-ocp-storage.html">2. Review OCP Storage</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="03-apache-cassandra.html">3. Snapshots with Cassandra</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-shared-volumes.html">4. Working with shared volumes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-cloud-snapshots.html">5. Cloud Snapshots</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-snapshot-schedules.html">6. Creating Snapshot Schedules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-autopilot.html">7. Automated capacity management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Dev Mode</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="module-01.html">Building an Application with rpms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="module-02.html">Managing an Application from GitHub</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="attrs-page.html">Attributes Page</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Default Title</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Default Title</a></li>
    <li><a href="03-apache-cassandra.html">3. Snapshots with Cassandra</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab 03 - Apache Cassandra</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Before we deploy cassandra, we will need to create a Portworx volume
(PVC) for Cassandra. In order to create PVCs, we need a StorageClass
which defined the class of storage available to us.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_storageclass"><a class="anchor" href="#_create_storageclass"></a>Create StorageClass</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Take a look the the below storage class.</p>
</div>
<div class="paragraph">
<p>Note that we define a replication factor of 2 to accelerate Cassandra
node recovery and we also defined a group name for Cassandra so that we
can take
<a href="https://docs.portworx.com/portworx-install-with-kubernetes/storage-operations/create-snapshots/snaps-3d/">3DSnapshots</a>
which will be consistent across the whole Cassandra cluster. In
production environment which larger clusters you would also add the
“fg=true” parameter to your StorageClass to ensure that Portworx places
each Cassandra volume and their replica on separate nodes so that in
case of node failure we never failover Kafka to a node where it is
already running. To enable this feature with a 3 volume group and 2
replicas you need a minimum of 6 worker nodes.</p>
</div>
<div class="paragraph">
<p>The parameters are declarative policies for your storage volume. See
<a href="https://docs.portworx.com/portworx-install-with-kubernetes/storage-operations/create-pvcs/dynamic-provisioning/">here</a>
for a full list of supported parameters.</p>
</div>
<div class="paragraph">
<p>Create the storage class using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc apply -f -
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: px-storageclass
provisioner: pxd.portworx.com
parameters:
  repl: "2"
  priority_io: "high"
  group: "cassandra_vg"
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have the StorageClass created, let&#8217;s deploy Cassandra!</p>
</div>
<div class="paragraph">
<p>In this step, we will deploy a 3 node Cassandra application using a
stateful set. To learn more about stateful sets follow this
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">link</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_the_cassandra_statefulset"><a class="anchor" href="#_create_the_cassandra_statefulset"></a>Create the Cassandra StatefulSet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a Cassandra
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a>
that uses a Portworx PVC.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc apply -f -
apiVersion: v1
kind: Service
metadata:
  labels:
    app: cassandra
  name: cassandra
spec:
  clusterIP: None
  ports:
    - port: 9042
  selector:
    app: cassandra
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cassandra
spec:
  serviceName: cassandra
  replicas: 1
  selector:
    matchLabels:
      app: cassandra
  template:
    metadata:
      labels:
        app: cassandra
    spec:
      # Use the stork scheduler to enable more efficient placement of the pods
      schedulerName: stork
      terminationGracePeriodSeconds: 1800
      containers:
      - name: cassandra
        image: gcr.io/google-samples/cassandra:v14
        imagePullPolicy: Always
        ports:
        - containerPort: 7000
          name: intra-node
        - containerPort: 7001
          name: tls-intra-node
        - containerPort: 7199
          name: jmx
        - containerPort: 9042
          name: cql
        resources:
          limits:
            cpu: "500m"
            memory: 1Gi
          requests:
          cpu: "500m"
          memory: 1Gi
        securityContext:
          privileged: true
          capabilities:
            add:
              - IPC_LOCK
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "PID=\$(pidof java) &amp;&amp; kill \$PID &amp;&amp; while ps -p \$PID &gt; /dev/null; do sleep 1; done"]
        env:
          - name: MAX_HEAP_SIZE
            value: 512M
          - name: HEAP_NEWSIZE
            value: 100M
          - name: CASSANDRA_SEEDS
            value: "cassandra-0.cassandra.default.svc.cluster.local"
          - name: CASSANDRA_CLUSTER_NAME
            value: "K8Demo"
          - name: CASSANDRA_DC
            value: "DC1-K8Demo"
          - name: CASSANDRA_RACK
            value: "Rack1-K8Demo"
          - name: CASSANDRA_AUTO_BOOTSTRAP
            value: "false"
          - name: POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - ls
          initialDelaySeconds: 15
          timeoutSeconds: 5
        # These volume mounts are persistent. They are like inline claims,
        # but not exactly because the names need to match exactly one of
        # the stateful pod volumes.
        volumeMounts:
        - name: cassandra-data
          mountPath: /cassandra_data
  # These are converted to volume claims by the controller
  # and mounted at the paths mentioned above.
  volumeClaimTemplates:
  - metadata:
      name: cassandra-data
    spec:
      storageClassName: px-storageclass
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: cqlsh
spec:
  containers:
  - name: cqlsh
    image: mikewright/cqlsh
    command:
      - sh
      - -c
      - "exec tail -f /dev/null"
apiVersion: stork.libopenstorage.org/v1alpha1
kind: Rule
metadata:
  name: cassandra-presnap-rule
rules:
  - podSelector:
      app: cassandra
    actions:
    - type: command
      value: nodetool flush
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Observe that the stateful set is exposed through a headless service.
Also note how PVCs will be dynamically created with each member of the
stateful set based on the <code>volumeClaimTemplates</code> and it&#8217;s <code>StorageClass</code>
sections. Finally, you will also see that we are starting with a single
node (replicas: 1).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verify_cassandra_pod_is_ready"><a class="anchor" href="#_verify_cassandra_pod_is_ready"></a>Verify Cassandra pod is ready</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below commands wait till the Cassandra pod are in ready state. Take note
of the node it&#8217;s running on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get pods  -o wide</code></pre>
</div>
</div>
<div class="paragraph">
<p>This takes a few minutes, when the cassandra-0 and cqlsh pods are in
STATUS <code>Running</code> and <code>READY 1/1</code>, hit <code>ctrl-c</code> to exit.</p>
</div>
<div class="paragraph">
<p>In this step, we will use pxctl to inspect the volume</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inspect_the_portworx_volume"><a class="anchor" href="#_inspect_the_portworx_volume"></a>Inspect the Portworx volume</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Portworx ships with a
<a href="https://docs.portworx.com/reference/cli/basics/">pxctl</a> command line that
can be used to manage Portworx.</p>
</div>
<div class="paragraph">
<p>Below we will use <code>pxctl</code> to inspect the underlying volumes for our
Cassandra pod.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">VOLS=$(oc get pvc | grep cassandra | awk '{print $3}')
pxctl volume inspect $VOLS</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make the following observations in the inspect output * <code>State</code>
indicates the volume is attached and shows the node on which it is
attached. This is the node where the Kubernetes pod is running. * <code>HA</code>
shows the number of configured replicas for this volume * <code>Labels</code> show
the name of the PVC for this volume * <code>Replica sets on nodes</code> shows the
px nodes on which volume is replicated</p>
</div>
<div class="paragraph">
<p>Now that we have Cassandra up, let&#8217;s proceed to run some tests!</p>
</div>
<div class="paragraph">
<p>In this step, we will initialize a sample database in our cassandra
instance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_table_and_insert_data"><a class="anchor" href="#_create_a_table_and_insert_data"></a>Create a table and insert data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start a CQL Shell session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -it cqlsh -- cqlsh cassandra-0.cassandra.default.svc.cluster.local --cqlversion=3.4.4</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you receive a traceback error, the cassandra pod may not be
ready yet. Wait a few seconds and try again.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a keyspace with replication of 3 and insert some data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE KEYSPACE portworx WITH REPLICATION = {'class':'SimpleStrategy','replication_factor':3};
USE portworx;
CREATE TABLE features (id varchar PRIMARY KEY, name varchar, value varchar);
INSERT INTO portworx.features (id, name, value) VALUES ('px-1', 'snapshots', 'point in time recovery!');
INSERT INTO portworx.features (id, name, value) VALUES ('px-2', 'cloudsnaps', 'backup/restore to/from any cloud!');
INSERT INTO portworx.features (id, name, value) VALUES ('px-3', 'STORK', 'convergence, scale, and high availability!');
INSERT INTO portworx.features (id, name, value) VALUES ('px-4', 'share-volumes', 'better than NFS, run wordpress on k8s!');
INSERT INTO portworx.features (id, name, value) VALUES ('px-5', 'DevOps', 'your data needs to be automated too!');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Select rows from the keyspace we just created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT id, name, value FROM portworx.features;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have data created let&#8217;s <code>quit</code> the cqlsh session.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flush_data_to_disk"><a class="anchor" href="#_flush_data_to_disk"></a>Flush data to disk</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we proceed to the failover test we will flush the in-memory data
onto disk so that when the cassandra-0 starts on another node it will
have access to the data that was just written (Cassandra keeps data in
memory and only flushes it to disk after 10 minutes by default).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -it cassandra-0 -- nodetool flush</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this step, we will simulate failure by cordoning the node where
Cassandra is running and then deleting the Cassandra pod. The pod will
then be resheduled by the
<a href="https://github.com/libopenstorage/stork/">STorage ORchestrator for
Kubernetes (STORK)</a> to make sure it lands on one of the nodes that has
of replica of the data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simulate_a_node_failure_to_force_cassandra_to_restart"><a class="anchor" href="#_simulate_a_node_failure_to_force_cassandra_to_restart"></a>Simulate a node failure to force Cassandra to restart</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we will cordon the node where Cassandra is running to simulate a
node failure or network partition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NODE=$(oc get pods -o wide | grep cassandra-0 | awk '{print $7}')
oc adm cordon ${NODE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then delete the Cassandra pod:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">POD=$(oc get pods -l app=cassandra -o wide | grep -v NAME | awk '{print $1}')
oc delete pod ${POD}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the cassandra pod gets deleted, Kubernetes will start to create a
new cassandra pod on another node.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verify_replacement_pod_starts_running"><a class="anchor" href="#_verify_replacement_pod_starts_running"></a>Verify replacement pod starts running</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below commands wait till the new cassandra pod is ready.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get pods -l app=cassandra -o wide</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the pod is in <code>Running</code> and <code>READY(1/1)</code> state. Hit ctrl-c to exit.</p>
</div>
<div class="paragraph">
<p>Before you proceed you should uncordon your node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc adm uncordon ${NODE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have the new cassandra pod running, let&#8217;s check if the
database we previously created is still intact.</p>
</div>
<div class="paragraph">
<p>In this step, we will check the state of our sample Cassandra database.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verify_data_is_still_available"><a class="anchor" href="#_verify_data_is_still_available"></a>Verify data is still available</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start a CQL Shell session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -it cqlsh -- cqlsh cassandra-0.cassandra.default.svc.cluster.local --cqlversion=3.4.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Select rows from the keyspace we previously created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT id, name, value FROM portworx.features;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have verify our data survived the node failure let&#8217;s <code>quit</code>
the cqlsh session before continuing to the next step.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Attention</div>
<div class="content">
<div class="paragraph">
<p>THIS STEP IS OPTIONAL Continue to create snapshots and restore
====== Scale the cluster</p>
</div>
<div class="paragraph">
<p>In this step, we will scale our Cassandra stateful set to 3 replicas to
show how portworx Dyanamically creates new PVCs as the statefulset
scales.</p>
</div>
<div class="paragraph">
<p>Run this command to add two nodes to the Cassandra cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc scale sts cassandra --replicas=3</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can watch the cassandra-1 and cassandra-2 pods get added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get pods -o wide</code></pre>
</div>
</div>
<div class="paragraph">
<p>After all pods are <code>READY 1/1</code> and <code>Running</code> you can hit <code>ctrl-c</code> to
exit the watch screen. Now, to verify that Cassandra is in a running
state you can run the nodetool status utility to verify the health of
our Cassandra cluster</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -it cassandra-0 -- nodetool status</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will take a minute or two for all three Cassandra nodes to come
online and discover each other. When it&#8217;s ready you should see the
following output in from the <code>nodetool status</code> command (address and host
ID will vary):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">root@cassandra-0:/# nodetool status
Datacenter: DC1-K8Demo
======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens       Owns (effective)  Host ID                               Rack
UN  10.32.0.4  153.59 KiB  32           100.0%            2fb16c55-1337-4b04-a4a4-13da82cca0cf  Rack1-K8Demo
UN  10.38.0.3  178.86 KiB  32           100.0%            ee7f6cb5-a631-4987-8888-28d008cfb959  Rack1-K8Demo
UN  10.40.0.5  101.46 KiB  32           100.0%            e2adf023-04f7-44a4-824b-55e75be7d74c  Rack1-K8Demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you see your Cassandra node is in Status=Up and State=Normal (UN)
that means the cluster is fully operational.</p>
</div>
<div class="paragraph">
<p>== Pro Tip: Use jq to get useful cluster configuration summary</p>
</div>
<div class="paragraph">
<p>Get the pods and the knowledge of the Hosts on which they are scheduled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods -l app=cassandra -o json | jq '.items[] | {"name": .metadata.name,"hostname": .spec.nodeName, "hostIP": .status.hostIP, "PodIP": .status.podIP}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this step, we will take a snapshot of all volumes for our Cassandra
cluster, then drop our database table.</p>
</div>
<div class="paragraph">
<p>== Take snapshot using oc</p>
</div>
<div class="paragraph">
<p>First let&#8217;s insert a new record in our features table so we can show
that the snapshot will take the latest available data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -it cqlsh -- cqlsh cassandra-0.cassandra.default.svc.cluster.local --cqlversion=3.4.4</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">INSERT INTO portworx.features (id, name, value) VALUES ('px-6', '3DSnaps', 'Application/Cluster aware snapshots!');
SELECT id, name, value FROM portworx.features;
quit</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re going to use STORK to take a 3DSnapshot of our Cassandra cluster.
Take a look at the px-snap.yaml file and notice that we are going to
force a <code>nodetool flush</code> command on eachcluster member before we take
the snapshot. As explained before, that will force all data to be
written to disk in order to ensure consistency of the snapshot. We also
defined the volume group name (cassandra_vg) so Portworx will
synchronously quiesce I/O on all volumes before triggering their
snapshots.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s take a snapshot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt; EOF | oc apply -f -
apiVersion: stork.libopenstorage.org/v1alpha1
kind: GroupVolumeSnapshot
metadata:
  name: cassandra-group-snapshot
spec:
  preExecRule: cassandra-presnap-rule
  pvcSelector:
    matchLabels:
      app: cassandra
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see the snapshots using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get stork-volumesnapshot</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you see all 3 volumesnapshots appear, take note of the names and
hit <code>ctrl-c</code> to exit the screen.</p>
</div>
<div class="paragraph">
<p>== Drop features table</p>
</div>
<div class="paragraph">
<p>Now we&#8217;re going to go ahead and do something stupid because we&#8217;re here
to learn.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -it cqlsh -- cqlsh cassandra-0.cassandra.default.svc.cluster.local --cqlversion=3.4.4</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">DROP TABLE IF EXISTS portworx.features;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SELECT id, name, value FROM portworx.features;
quit</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should have received an “Error” since the table is deleted. Ok, so
we deleted our database, what now?</p>
</div>
<div class="paragraph">
<p>Create clones from your snapshots and restore from those snapshots.</p>
</div>
<div class="paragraph">
<p>First edit <code>/tmp/vols-from-snaps</code> and insert the volumesnapshots names
from the above <code>oc get stork-volumesnapshots</code> output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cassandra-snap-data-cassandra-restored-0
  annotations:
    snapshot.alpha.kubernetes.io/snapshot: $(oc get stork-volumesnapshot | sed -n '/^cassandra-group-snapshot-cassandra-data-cassandra-0-/s/\s\+[^ ]\+$//p')
spec:
  accessModes:
     - ReadWriteOnce
  storageClassName: stork-snapshot-sc
  resources:
    requests:
      storage: 10Gi

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cassandra-snap-data-cassandra-restored-1
  annotations:
    snapshot.alpha.kubernetes.io/snapshot: $(oc get stork-volumesnapshot | sed -n '/^cassandra-group-snapshot-cassandra-data-cassandra-1-/s/\s\+[^ ]\+$//p')
spec:
  accessModes:
     - ReadWriteOnce
  storageClassName: stork-snapshot-sc
  resources:
    requests:
      storage: 10Gi

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cassandra-snap-data-cassandra-restored-2
  annotations:
    snapshot.alpha.kubernetes.io/snapshot: $(oc get stork-volumesnapshot | sed -n '/^cassandra-group-snapshot-cassandra-data-cassandra-2-/s/\s\+[^ ]\+$//p')
spec:
  accessModes:
     - ReadWriteOnce
  storageClassName: stork-snapshot-sc
  resources:
    requests:
      storage: 10Gi
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the PVCs</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pvc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restore cassandra. We delete the original Cassandra deployment only
because we dont have enough nodes in this lab to host two. Then we
create the new cassandra statefulset based on our cloned snapshots.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc delete sts cassandra</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc apply -f -
apiVersion: v1
kind: Service
metadata:
  labels:
    app: cassandra-restored
  name: cassandra-restored
spec:
  clusterIP: None
  ports:
    - port: 9042
  selector:
    app: cassandra-restored
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cassandra-restored
spec:
  serviceName: cassandra-restored
  replicas: 1
  selector:
    matchLabels:
      app: cassandra-restored
  template:
    metadata:
      labels:
        app: cassandra-restored
    spec:
      # Use the stork scheduler to enable more efficient placement of the pods
      schedulerName: stork
      terminationGracePeriodSeconds: 1800
      containers:
      - name: cassandra
        image: gcr.io/google-samples/cassandra:v14
        imagePullPolicy: Always
        ports:
        - containerPort: 7000
          name: intra-node
        - containerPort: 7001
          name: tls-intra-node
        - containerPort: 7199
          name: jmx
        - containerPort: 9042
          name: cql
        resources:
          limits:
            cpu: "500m"
            memory: 1Gi
          requests:
           cpu: "500m"
           memory: 1Gi
        securityContext:
          privileged: true
          capabilities:
            add:
              - IPC_LOCK
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "PID=\$(pidof java) &amp;&amp; kill \$PID &amp;&amp; while ps -p \$PID &gt; /dev/null; do sleep 1; done"]
        env:
          - name: MAX_HEAP_SIZE
            value: 512M
          - name: HEAP_NEWSIZE
            value: 100M
          - name: CASSANDRA_SEEDS
            value: "cassandra-restored-0.cassandra-restored.default.svc.cluster.local"
          - name: CASSANDRA_CLUSTER_NAME
            value: "K8Demo"
          - name: CASSANDRA_DC
            value: "DC1-K8Demo"
          - name: CASSANDRA_RACK
            value: "Rack1-K8Demo"
          - name: CASSANDRA_AUTO_BOOTSTRAP
            value: "false"
          - name: POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - ls
          initialDelaySeconds: 15
          timeoutSeconds: 5
        # These volume mounts are persistent. They are like inline claims,
        # but not exactly because the names need to match exactly one of
        # the stateful pod volumes.
        volumeMounts:
        - name: cassandra-snap-data
          mountPath: /cassandra_data
  # These are converted to volume claims by the controller
  # and mounted at the paths mentioned above.
  volumeClaimTemplates:
  - metadata:
      name: cassandra-snap-data
    spec:
      storageClassName: px-storageclass
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: cqlsh-restored
spec:
  containers:
  - name: cqlsh
    image: mikewright/cqlsh
    command:
      - sh
      - -c
      - "exec tail -f /dev/null"
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for restored cassandra database to be Running (1/1). <em>Note there
will be only 1 replica restored</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you see all pods Running (1/1), hit <code>ctrl-c</code> to exit the screen.</p>
</div>
<div class="paragraph">
<p>New let&#8217;s verify the data is restored.</p>
</div>
<div class="paragraph">
<p>Start a CQL Shell session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -it cqlsh -- cqlsh cassandra-restored-0.cassandra-restored.default.svc.cluster.local --cqlversion=3.4.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Select rows from the keyspace we previously created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT id, name, value FROM portworx.features;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have now restored from a snapshot! Go ahead and <code>quit</code> the cqlsh
session before finishing.</p>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-review-ocp-storage.html" class="query-params-link">2. Review OCP Storage</a></span>
  <span class="next"><a href="04-shared-volumes.html" class="query-params-link">4. Working with shared volumes</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>  </div>
</main>
</div>
<footer class="footer">
  <a href="https://demo.redhat.com" target="_blank" class="poweredBy"><p>Powered by</p><div class="labInfo_poweredBy" style="display: block; width: 260px;"><svg class="labInfo_poweredByLogo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1508.5 178.739"><g fill="#111"><path d="M316.6 63.2v-56H342a21.279 21.279 0 0 1 7.8 1.3 18.111 18.111 0 0 1 5.9 3.5 15.577 15.577 0 0 1 5 11.8 15.051 15.051 0 0 1-3.1 9.5 16.836 16.836 0 0 1-8.4 5.8l12.5 24.1h-9.3l-11.6-23H325v23Zm24.7-48.6H325v18.7h16.3q5.25 0 8.1-2.7a8.7 8.7 0 0 0 2.8-6.6 8.7 8.7 0 0 0-2.8-6.6c-1.8-1.9-4.5-2.8-8.1-2.8ZM364.1 42.8a20.674 20.674 0 0 1 1.6-8.2 20.288 20.288 0 0 1 4.3-6.7 19.92 19.92 0 0 1 6.5-4.5 19.718 19.718 0 0 1 8-1.6 18.463 18.463 0 0 1 7.8 1.6 18.677 18.677 0 0 1 6.2 4.5 20.927 20.927 0 0 1 4.1 6.8 23.2 23.2 0 0 1 1.5 8.4v2.3H372a13.822 13.822 0 0 0 4.6 8.4 13.6 13.6 0 0 0 9.1 3.3 15.553 15.553 0 0 0 5.7-1 12.858 12.858 0 0 0 4.6-2.6l5.1 5a25.983 25.983 0 0 1-7.4 4.1 24.69 24.69 0 0 1-8.4 1.3 21.306 21.306 0 0 1-8.4-1.6 22.763 22.763 0 0 1-6.8-4.4 20.788 20.788 0 0 1-4.5-6.7 23.2 23.2 0 0 1-1.5-8.4Zm20.2-14.2a11.527 11.527 0 0 0-8 3 13.046 13.046 0 0 0-4.2 7.8h24.2a13.091 13.091 0 0 0-4.2-7.8 11.106 11.106 0 0 0-7.8-3ZM443.1 63.2v-3.8a19.448 19.448 0 0 1-5.8 3.3 18.924 18.924 0 0 1-6.7 1.2 19.824 19.824 0 0 1-14.6-6.1 22.268 22.268 0 0 1-4.4-6.7 21.812 21.812 0 0 1 0-16.4A20.534 20.534 0 0 1 416 28a19.335 19.335 0 0 1 6.6-4.5 20.334 20.334 0 0 1 8.2-1.6 20.7 20.7 0 0 1 6.6 1 19.415 19.415 0 0 1 5.7 3V7.2l8-1.8v57.8Zm-25.2-20.4a13.718 13.718 0 0 0 4 10.1 13.45 13.45 0 0 0 9.8 4.1 14.956 14.956 0 0 0 6.4-1.3 15.954 15.954 0 0 0 4.9-3.6V33.6a14.988 14.988 0 0 0-4.9-3.5 15.271 15.271 0 0 0-6.4-1.3 13.423 13.423 0 0 0-9.9 4 13.806 13.806 0 0 0-3.9 10ZM478.1 63.2v-56h8.4v24h29.8v-24h8.4v56h-8.4V38.8h-29.8v24.4ZM547.2 64a16.483 16.483 0 0 1-10.8-3.5 11.037 11.037 0 0 1-4.2-8.9 10.375 10.375 0 0 1 4.7-9.2 20.76 20.76 0 0 1 11.8-3.2 27.841 27.841 0 0 1 5.8.6 27.374 27.374 0 0 1 5.3 1.6v-4.3a8.143 8.143 0 0 0-2.6-6.5 11.452 11.452 0 0 0-7.4-2.2 20.788 20.788 0 0 0-6 .9 34.616 34.616 0 0 0-6.6 2.6l-3-6a54.169 54.169 0 0 1 8.4-3.1 33.18 33.18 0 0 1 8.3-1.1c5.2 0 9.3 1.3 12.2 3.8s4.4 6.1 4.4 10.8v27h-7.8v-3.5a19.441 19.441 0 0 1-5.8 3.2 23.54 23.54 0 0 1-6.7 1Zm-7.3-12.6a5.646 5.646 0 0 0 2.6 4.8 11.193 11.193 0 0 0 6.6 1.8 16.256 16.256 0 0 0 5.9-1 14.449 14.449 0 0 0 4.9-2.9V47a19.778 19.778 0 0 0-4.8-1.8 24.933 24.933 0 0 0-5.7-.6 11.859 11.859 0 0 0-6.8 1.8 5.728 5.728 0 0 0-2.7 5ZM580.6 53.2v-24H572v-6.7h8.6V12.1l7.9-1.9v12.3h12v6.7h-12v22.1a5.94 5.94 0 0 0 1.4 4.4c.9.9 2.5 1.3 4.6 1.3a23.637 23.637 0 0 0 3-.2 10.857 10.857 0 0 0 2.8-.8v6.7a19.28 19.28 0 0 1-3.8.9 27.484 27.484 0 0 1-3.8.3c-3.9 0-7-.9-9-2.8-2-1.7-3.1-4.4-3.1-7.9Z"></path></g><path d="M127 90.2c12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4L149.8 37c-1.7-7.1-3.2-10.3-15.7-16.6-9.7-5-30.8-13.1-37.1-13.1-5.8 0-7.5 7.5-14.4 7.5-6.7 0-11.6-5.6-17.9-5.6-6 0-9.9 4.1-12.9 12.5 0 0-8.4 23.7-9.5 27.2a4.216 4.216 0 0 0-.3 1.9c0 9.2 36.3 39.4 85 39.4Zm32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3C21.8 58.8 0 61.8 0 81c0 31.5 74.6 70.3 133.7 70.3 45.3 0 56.7-20.5 56.7-36.6-.1-12.8-11-27.3-30.9-35.9Z" fill="#e00"></path><path d="M159.5 78.8c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3l3.7-9.1a4.877 4.877 0 0 0-.3 2c0 9.2 36.3 39.4 85 39.4 12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4Z"></path><path d="M253.5 158.7a2.22 2.22 0 0 1-2.2-2.2V2.2a2.2 2.2 0 0 1 4.4 0v154.2a2.242 2.242 0 0 1-2.2 2.3Z" fill="#111"></path><text data-name="Demo Platform" transform="translate(1186 149)" fill="#111" font-size="82" font-family="'RedHatDisplay', 'Overpass', overpass, helvetica, arial, sans-serif" font-weight="700"><tspan x="-877.892" y="0">Demo Platform</tspan></text></svg></div></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
